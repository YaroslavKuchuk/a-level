# Урок №42.  Асинхронные actions, структура приложения, как подружить API и MVC, Dependency Injection

## Полезные ссылки

[Асинхронные методы](https://metanit.com/sharp/mvc5/3.8.php)

[Асинхронное программирование в приложениях ASP.NET MVC 4](https://habr.com/ru/post/142372/)

[Using Asynchronous Methods in ASP.NET MVC 4](https://docs.microsoft.com/en-us/aspnet/mvc/overview/performance/using-asynchronous-methods-in-aspnet-mvc-4)

[DTO vs POCO vs Value Object](https://habr.com/ru/post/268371/)

[Внедрение зависимости](https://ru.wikipedia.org/wiki/%D0%92%D0%BD%D0%B5%D0%B4%D1%80%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B7%D0%B0%D0%B2%D0%B8%D1%81%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8)

[Dependency injection](https://habr.com/ru/post/350068/)

[Внедрение зависимостей через поля — плохая практика](https://habr.com/ru/post/334636/)

## Асинхронные actions

![Async operations](/Module-5/images/async-operations.png)

* Web Server получает поток из thread pool (рабочий поток) и планирует его для обработки запроса

* Этот рабочий поток иницализирует асинхронную операцию.

* Рабочий поток возвращается в thread pool для обработки нового запроса

* Когда асинхронная операция выполнена, ASP.NET уведомляется об этом

* Web server получает рабочий поток из пула (может отличаться от стартового потока) 
для обработки остатка реквеста, включая рендеринг ответа.

![Async pipeline](/Module-5/images/async-pipeline.png)

## Практика

Включаем асинхронность в наших Phonebook. Что изменилось?

## Лучшие практики программирования

![Primary antipatterns](/Module-5/images/antipatterns-evolution.png)

В разное время треш делали разными способами, но результат всегда впечатлял!

![Shitty stuff](/Module-5/images/shitty-code.png)

### Слоенное приложение, разные типы моделей

![Different models](/Module-5/images/different-models.png)

**DTO** — это класс, содержащий данные без какой-либо логики для работы с ними. 
DTO обычно используются для передачи данных между различными приложениями, либо между слоями 
внутри одного приложения.

**Value Object** — это полноценный член вашей доменной модели. Он подчиняется тем же правилам, что и 
сущности (Entities). Единственное отличие между Value Object и Entity в том, что у Value Object-а 
нет собственной идентичности. Это означает, что два Value Object-а с одинаковыми свойствами могут считаться 
идентичными, в то время как две сущности отличаются друг от друга даже в случае 
если их свойства полностью совпадают.

Value Object-ы могут содержать логику и обычно они не используются для передачи информации между приложениями.

Понятие POCO означает использование настолько простых классов насколько возможно для моделирования предметной 
области. Это понятие помогает придерживаться принципов YAGNI, KISS и остальных best practices. 
POCO классы могут содержать логику.

![Different models](/Module-5/images/models-comparison.png)

![Different models](/Module-5/images/models-diagram.png)

## Практика

Есть некоторый домен. Пусть это категория - {Id, Name}. Делаем костяк приложения для него. 
Используем модели разных уровней.

## Web API Client

![Web API Client](/Module-5/images/webapi-client.png)

## Практика

Подключаем Phonebook API к веб-интерфейсу. Для чего в начале работ мы вынесли модели в отдельную сборку?

## Dependency Injection

![DI](/Module-5/images/di-general.png)

![DI](/Module-5/images/di.png)

Внедрение зависимостей — это стиль настройки объекта, при котором поля объекта задаются внешней сущностью. 
Другими словами, объекты настраиваются внешними объектами. DI — это альтернатива самонастройке объектов.

При настоящем внедрении зависимости объект пассивен и не предпринимает вообще никаких шагов для выяснения 
зависимостей, а предоставляет для этого сеттеры и/или принимает своим конструктором аргументы, 
посредством которых внедряются зависимости.

![DI Workflow](/Module-5/images/di-workflow.png)

Конструктор – ЗАВИСИМОСТИ ОБЯЗАТЕЛЬНЫ
Сеттер
Поле

![Ninject](/Module-5/images/ninject.png)

## Практика. 

В костяк приложения для некоторых категорий внедрить Ninject.

## Домашнее задание

1. **Теория**
2. Какие еще REST-клиенты есть в .NET Framework? Рассказать и объяснить отличия.
3. Какие еще DI-контейнеры есть в .NET Framework? Рассказать и объяснить отличия.

4. Расширить Phonebook

* Добавить репозитории для работы с текстовыми файлами
* Добавить уровень бизнес-логики (просто ретрансляция)
* Связать модули через Ninject
* Подключить API к MVC на ВСЕ операции
* Попрактиковать валидацию, как на стороне клиента, так и на стороне API.